<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Comunit√°ria</title>
    <link rel="icon" href="/images/livro.png" type="image/png">
    <link rel="stylesheet" href="/assets/css/style.css">
    <script type="module" src="/assets/js/homepage.js" defer></script>
    <script type="module" src="/assets/js/modal.js" defer></script>
</head>
<body>

    <div id="bookstore-view" class="bookstore-view" style="display: block;">
        <header class="header">
            <h1 class="logo"><img src="/images/livro-32px.png"> Biblioteca Comunit√°ria</h1>
            <div class="header-right">
                <div class="search-bar">
                    <a href="/auth/logout" class="logout-btn" title="Sair"><img src="/images/sair-cinza.png"></a>
                    <a href="/donate" id="donate-btn" class="btn-doar">Doar Livro</a> 
                </div>
                
                <form action="/search-for" method="get" class="search-bar">
                    <div class="custom-select-wrapper">
                        <input type="hidden" name="type" id="search-type-input" value="<%= searchType || 'titulo' %>">

                        <div class="custom-select-trigger">
                            <span>
                                <% if(searchType === 'autor') { %> Autor
                                <% } else if(searchType === 'genero') { %> G√™nero
                                <% } else { %> T√≠tulo <% } %>
                            </span>
                            <div class="arrow"></div>
                        </div>

                        <div class="custom-options">
                            <span class="custom-option" data-value="titulo">T√≠tulo</span>
                            <span class="custom-option" data-value="autor">Autor</span>
                            <span class="custom-option" data-value="genero">G√™nero</span>
                        </div>
                    </div>
                    
                    <input type="text" name="term" value="<%= searchTerm %>" placeholder="Pesquisar..."> 
                    <button id="search-btn" type="submit">üîç</button>
                </form>
            </div>
        </header>

        <h2 class="header-subtitle">Encontre, resgate ou doe livros na comunidade</h2>

        <% if (currentUrl === '/search-for') { %>
            <a href="/" class="back-button2">Voltar</a>
        <% } %>

        <div id="book-list" class="book-list"></div>

        <div class="pagination">
            <% 
                let urlBase = '';

                // L√≥gica inteligente:
                // Se o usu√°rio digitou algo (searchTerm), a pagina√ß√£o deve manter a pesquisa e o tipo.
                if (searchTerm) {
                    urlBase = `/search-for?term=${encodeURIComponent(searchTerm)}&type=${encodeURIComponent(searchType)}&page=`;
                } else {
                    // Se n√£o tem pesquisa, pagina√ß√£o simples na raiz
                    urlBase = `/?page=`;
                }
            %>

            <% if (page > 1) { %>
                <a href="<%= urlBase %><%= page - 1 %>" class="page-btn">&laquo; Anterior</a>
            <% } %>

            <% for (let i = 1; i <= totalPages; i++) { %>
                <a href="<%= urlBase %><%= i %>" class="page-btn <%= page === i ? 'active' : '' %>"><%= i %></a>
            <% } %>

            <% if (page < totalPages) { %>
                <a href="<%= urlBase %><%= page + 1 %>" class="page-btn">Pr√≥ximo &raquo;</a>
            <% } %>
        </div>
    </div>

    <div id="book-details-view" class="book-details-view">
        <button id="back-button" class="back-button">&larr; Voltar</button>
        <div id="book-details" class="book-details-container">
        </div>
    </div>
    
    <% if ((messages?.success || []).length > 0) { %>
        <% messages.success.forEach(msg => { %>
            <div id="message-modal" class="message-modal" style="display:flex;">
                <div class="message-box">
                    <h3 id="modal-title"><%= msg.title %></h3>
                    <p id="modal-message"><%= msg.message %></p>
                    <button id="close-modal">OK</button>
                </div>
            </div>
        <% }) %>
    <% } %>

    <% if ((messages?.error || []).length > 0) { %>
        <% messages.error.forEach(msg => { %>
            <div id="message-modal" class="message-modal" style="display:flex;">
                <div class="message-box">
                    <h3 id="modal-title"><%= msg.title %></h3>
                    <p id="modal-message"><%= msg.message %></p>
                    <button id="close-modal">OK</button>
                </div>
            </div>
        <% }) %>    
    <% } %>

    <!-- Aqui mandamos os dados para o JS -->
    <script id="books" type="application/json">
        <%- JSON.stringify(books) %>
    </script>
</body>
</html>